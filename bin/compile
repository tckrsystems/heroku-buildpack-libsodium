#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir> <env-dir>

### Configure Environment

set -eo pipefail

### Constants

### Paths

BASE_DIR=$PWD # absolute path
BUILD_DIR=${1:-}
CACHE_DIR=${2:-}
ENV_DIR=${3:-}
INSTALL_DIR="$BUILD_DIR/vendor/libopaque"

mkdir -p $CACHE_DIR
mkdir -p $INSTALL_DIR

export_env_dir() {
  local env_dir=$1
  if [ -d "$env_dir" ]; then
    local whitelist_regex=${2:-''}
    local blacklist_regex=${3:-'^(PATH|GIT_DIR|CPATH|CPPATH|LD_PRELOAD|LIBRARY_PATH)$'}
    if [ -d "$env_dir" ]; then
      for e in $(ls $env_dir); do
        echo "$e" | grep -E "$whitelist_regex" | grep -qvE "$blacklist_regex" &&
        export "$e=$(cat $env_dir/$e)"
        :
      done
    fi
  fi
}
export_env_dir "$ENV_DIR"

OPAQUE_DIR=libopaque-master
TARBALL=master.tar.gz

cd $CACHE_DIR
echo -n "-----> Fetching $OPAQUE_DIR... "
curl --silent --remote-name --insecure --location https://github.com/stef/libopaque/archive/refs/heads/master.tar.gz
tar -xf $TARBALL
rm $TARBALL
echo "done"

echo -n "-----> Compiling $OPAQUE_DIR... "
echo -n "-----> About to change directory... "
cd "$OPAQUE_DIR/src"
echo -n "-----> About to make... "
make &> /dev/null
echo "done"
