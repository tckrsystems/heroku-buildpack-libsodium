#!/bin/sh

BUILD_DIR=$1
CACHE_DIR=$2

echo "-----> Installing libsodium-dev and pkgconf"
apt-get update
apt-get install -y libsodium-dev pkgconf

echo "-----> Installing libopaque"

LIBOPAQUE_GIT_REPO="https://github.com/stef/libopaque.git"

# Clone the repository
if [ ! -d "${CACHE_DIR}/libopaque" ]; then
  git clone "${LIBOPAQUE_GIT_REPO}" "${CACHE_DIR}/libopaque"
fi

# Update the repository to the latest version and init submodules
cd "${CACHE_DIR}/libopaque"
git fetch origin
git reset --hard origin/master
git submodule update --init --recursive --remote

# Compile the library
cd src
make

# Copy the compiled library and headers to the vendor folder
mkdir -p "${BUILD_DIR}/.heroku/vendor/lib"
mkdir -p "${BUILD_DIR}/.heroku/vendor/include"
cp *.a "${BUILD_DIR}/.heroku/vendor/lib"
cp *.h "${BUILD_DIR}/.heroku/vendor/include"

# Set the necessary environment variables
export LDFLAGS="-L${BUILD_DIR}/.heroku/vendor/lib ${LDFLAGS}"
export CPPFLAGS="-I${BUILD_DIR}/.heroku/vendor/include ${CPPFLAGS}"
export LD_LIBRARY_PATH="${BUILD_DIR}/.heroku/vendor/lib:${LD_LIBRARY_PATH}"

echo "-----> libopaque installed"
